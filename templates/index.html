<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Player Card Generator - Dual Eval</title>
    
    <script src="/static/tailwind.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'], display: ['Cinzel', 'serif'] },
                    colors: {
                        'chess-dark': '#0f0f13', 'chess-panel': '#1a1a20', 'chess-accent': '#3b82f6', 
                        'chess-gold': '#fbbf24', 'card-bg': '#121212',
                    }
                }
            }
        }
    </script>

    <style>
        .glass-panel { background: rgba(26, 26, 32, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .theme-common { --primary-glow: rgba(59, 130, 246, 0.6); --border-gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 50%, #2563eb 100%); --text-accent: #60a5fa; --bg-gradient: linear-gradient(160deg, #1e293b 0%, #0f172a 100%); --hex-border: #3b82f6; }
        .theme-titled { --primary-glow: rgba(251, 191, 36, 0.6); --border-gradient: linear-gradient(135deg, #b45309 0%, #fbbf24 50%, #fcd34d 100%); --text-accent: #fcd34d; --bg-gradient: linear-gradient(160deg, #451a03 0%, #1a0f0a 100%); --hex-border: #fbbf24; }
        .theme-gm { --primary-glow: rgba(167, 139, 250, 0.6); --border-gradient: linear-gradient(135deg, #7c3aed 0%, #a78bfa 50%, #8b5cf6 100%); --text-accent: #a78bfa; --bg-gradient: linear-gradient(160deg, #2e1065 0%, #020617 100%); --hex-border: #c4b5fd; }
        .royal-shape { clip-path: polygon(25px 0, calc(100% - 25px) 0, 100% 25px, 100% calc(100% - 25px), calc(100% - 25px) 100%, 25px 100%, 0 calc(100% - 25px), 0 25px); }
        #player-card { width: 400px; height: 680px; position: relative; background: var(--border-gradient); padding: 4px; box-shadow: 0 0 50px var(--primary-glow); transition: all 0.5s ease; }
        .card-inner-content { width: 100%; height: 100%; background: var(--bg-gradient); position: relative; overflow: hidden; }
        .bg-pattern { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 20px 20px; opacity: 0.5; z-index: 0; }
        .hex-wrapper { width: 140px; height: 140px; clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); background: var(--hex-border); padding: 3px; margin: 0 auto; position: relative; z-index: 10; box-shadow: 0 0 30px var(--primary-glow); }
        .hex-inner { width: 100%; height: 100%; background: #000; clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .hex-inner img { width: 100%; height: 100%; object-fit: cover; }
        .metric-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .metric-name { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(255,255,255,0.9); width: 40px; text-align: left; padding-right: 4px; }
        .metric-bar-bg { flex-grow: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .metric-bar-fill { height: 100%; background: var(--text-accent); width: 0%; transition: width 1s ease-out; box-shadow: 0 0 5px var(--text-accent); }
        .metric-value { font-size: 0.7rem; font-weight: 700; color: white; width: 25px; text-align: right; padding-left: 5px; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .royal-decor-top { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 80%; height: 1px; background: linear-gradient(90deg, transparent, var(--text-accent), transparent); z-index: 5; }
        .royal-decor-bottom { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 80%; height: 1px; background: linear-gradient(90deg, transparent, var(--text-accent), transparent); z-index: 5; }
    </style>
</head>
<body class="bg-chess-dark text-gray-200 min-h-screen font-sans selection:bg-blue-500 selection:text-white flex items-center justify-center p-4">

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-xl z-50 hidden transition-opacity duration-300">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span id="toast-msg">Error message here</span>
    </div>

    <div class="container max-w-6xl mx-auto flex flex-col lg:flex-row gap-8 items-start justify-center">

        <div class="w-full lg:w-1/3 glass-panel p-6 rounded-2xl shadow-2xl flex flex-col gap-6 relative z-20">
            <div class="flex items-center gap-3 border-b border-gray-700 pb-4">
                <img src="/static/images/knight.png" class="w-10 h-10 object-contain drop-shadow-blue-glow" alt="Logo">
                <div>
                    <h1 class="text-xl font-display font-bold text-white">Card Generator</h1>
                    <p class="text-xs text-gray-400">Powered by ChessAI360</p>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Chess.com Username</label>
                    <div class="flex gap-2">
                        <input type="text" id="usernameInput" placeholder="e.g. Hikaru" 
                            class="w-full bg-black/40 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors text-white text-sm placeholder-gray-600">
                        <button onclick="startProcess()" id="searchBtn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-5 rounded-lg font-bold transition-all shadow-lg hover:shadow-blue-500/30 flex items-center justify-center">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div id="progress-container" class="hidden w-full bg-gray-700 rounded-full h-2.5 mt-4">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    <p id="progress-text" class="text-xs text-center mt-1 text-gray-400">0 / 100 Games Analyzed</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Custom Image</label>
                    <label class="flex items-center gap-3 w-full bg-black/40 border border-gray-700 border-dashed rounded-lg px-4 py-3 cursor-pointer hover:border-blue-500/50 hover:bg-black/60 transition-all group">
                        <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center group-hover:bg-blue-600 transition-colors">
                            <i class="fas fa-camera text-gray-400 group-hover:text-white text-xs"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-300 font-medium">Upload File</span>
                            <span class="text-[10px] text-gray-500">Supports JPG, PNG</span>
                        </div>
                        <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    </label>
                </div>

                <div class="pt-4 border-t border-gray-700">
                    <button onclick="downloadCard()" id="downloadBtn" disabled
                        class="w-full bg-gray-800 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed text-white py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2 group">
                        <i class="fas fa-download group-hover:animate-bounce"></i> Download Card
                    </button>
                </div>
            </div>

  
                    <button onclick="document.getElementById('info-modal').classList.remove('hidden')" 
						class="w-full bg-blue-900/20 hover:bg-blue-900/40 border border-blue-500/30 hover:border-blue-500/50 p-4 rounded-xl transition-all group text-left">
						<div class="flex gap-4 items-center">
							<div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center group-hover:scale-110 transition-transform">
								<i class="fas fa-microchip text-blue-400 text-lg"></i>
							</div>
							<div>
								<h3 class="font-bold text-blue-100 text-sm mb-1">How It Works?</h3>
							</div>
							<i class="fas fa-chevron-right text-blue-500/30 ml-auto group-hover:text-blue-400 transition-colors"></i>
						</div>
					</button>
       
        </div>

        <div class="w-full lg:w-auto flex justify-center perspective-1000">
            <div id="player-card" class="theme-common royal-shape select-none">
                <div class="card-inner-content royal-shape">
                    <div class="bg-pattern"></div>
                    <div class="royal-decor-top"></div>
                    <div class="royal-decor-bottom"></div>
                    <div class="absolute top-2 left-2 w-8 h-8 border-t border-l border-[var(--text-accent)] opacity-30"></div>
                    <div class="absolute top-2 right-2 w-8 h-8 border-t border-r border-[var(--text-accent)] opacity-30"></div>
                    <div class="absolute bottom-2 left-2 w-8 h-8 border-b border-l border-[var(--text-accent)] opacity-30"></div>
                    <div class="absolute bottom-2 right-2 w-8 h-8 border-b border-r border-[var(--text-accent)] opacity-30"></div>

                    <div class="relative z-10 pt-12 px-6 text-center">
                        <div class="absolute top-10 left-8 flex flex-col items-center">
                            <span class="text-[9px] tracking-[0.2em] font-bold text-gray-400 uppercase">OVR</span>
                            <span id="overall-score" class="text-4xl font-display font-black text-[var(--text-accent)] leading-none drop-shadow-lg">--</span>
                        </div>
                        <div class="absolute top-10 right-8 flex flex-col items-center">
                            <img id="country-flag" src="/proxy_image?url=https://flagcdn.com/w40/un.png" class="w-8 rounded shadow-md opacity-80" alt="Flag">
                        </div>
                        <div class="hex-wrapper mb-4 transition-transform duration-500 hover:scale-105">
                            <div class="hex-inner">
                                <img id="player-img" src="/proxy_image?url=https://www.chess.com/bundles/web/images/user-image.svg" alt="Player">
                            </div>
                        </div>
                        <div id="title-badge" class="hidden inline-block bg-[var(--hex-border)] text-black font-black text-xs px-2 py-0.5 rounded shadow-lg mb-2 uppercase tracking-wide transform -skew-x-12">GM</div>
                        <h2 id="player-username" class="text-3xl font-display font-black text-white tracking-widest truncate px-2 drop-shadow-md uppercase mt-1">USERNAME</h2>
                        <p id="player-description" class="text-sm font-display font-bold text-[var(--text-accent)] uppercase tracking-widest mt-2 px-4 py-1 border-t border-b border-[var(--text-accent)] inline-block opacity-90 bg-black/30">Player Style</p>
                    </div>

                    <div class="relative z-10 grid grid-cols-3 gap-2 px-6 py-6 mt-1">
                        <div class="text-center p-2 bg-white/5 backdrop-blur-sm border-t border-b border-white/10">
                            <div class="text-[9px] text-gray-400 uppercase tracking-wider mb-1">Rapid</div>
                            <div id="rating-rapid" class="text-lg font-bold text-[var(--text-accent)]">---</div>
                        </div>
                        <div class="text-center p-2 bg-white/5 backdrop-blur-sm border-t border-b border-white/10">
                            <div class="text-[9px] text-gray-400 uppercase tracking-wider mb-1">Blitz</div>
                            <div id="rating-blitz" class="text-lg font-bold text-[var(--text-accent)]">---</div>
                        </div>
                        <div class="text-center p-2 bg-white/5 backdrop-blur-sm border-t border-b border-white/10">
                            <div class="text-[9px] text-gray-400 uppercase tracking-wider mb-1">Bullet</div>
                            <div id="rating-bullet" class="text-lg font-bold text-[var(--text-accent)]">---</div>
                        </div>
                    </div>

                    <div class="relative z-10 px-6 pb-6">
                        <div id="metrics-container" class="grid grid-cols-2 gap-x-6 gap-y-1 mt-6"></div>
                    </div>

                    <div class="absolute bottom-2 w-full text-center z-10">
                        <img src="/static/images/circle_logo.png" class="h-16 mx-auto opacity-90" alt="Logo">
                    </div>
                </div>
            </div>
        </div>
    </div>
	
	
	<div id="info-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm hidden p-4 transition-all duration-300">
    <div class="glass-panel w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col relative overflow-hidden border border-blue-500/20">
        
        <div class="p-6 border-b border-white/10 flex justify-between items-center bg-blue-900/10">
            <div class="flex items-center gap-3">
                <i class="fas fa-brain text-blue-400 text-2xl"></i>
                <h2 class="text-xl font-display font-bold text-white">The Science Behind ChessAI360</h2>
            </div>
            <button onclick="document.getElementById('info-modal').classList.add('hidden')" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-8 overflow-y-auto custom-scrollbar space-y-8">
            
            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <h3 class="text-lg font-bold text-blue-400 uppercase tracking-widest">Engine Technology</h3>
                    <p class="text-sm text-gray-300 leading-relaxed">
                        ChessAI360 isn't just a stats scraper. We download your last 100 games via the <span class="text-white font-bold">Chess.com Open API</span> and run them through a custom engine pipeline.
                    </p>
                    <p class="text-sm text-gray-300 leading-relaxed">
                        We combine <strong class="text-blue-300">Classical Stockfish</strong> (to understand positional concepts like space and mobility) with <strong class="text-blue-300">AI</strong> evaluation (for human-like win probabilities). This allows us to measure "Intangibles" like resilience and intuition that standard engines miss.
                    </p>
                </div>
                <div class="bg-blue-500/5 rounded-xl p-6 border border-blue-500/10">
                    <h3 class="text-lg font-bold text-blue-400 uppercase tracking-widest mb-4">Data Privacy</h3>
                    <ul class="space-y-3 text-sm text-gray-300">
                        <li class="flex gap-3"><i class="fas fa-check text-green-500 mt-1"></i> Uses only public, open-access game data.</li>
                        <li class="flex gap-3"><i class="fas fa-check text-green-500 mt-1"></i> No passwords or authentication required.</li>
                        <li class="flex gap-3"><i class="fas fa-check text-green-500 mt-1"></i> Analysis runs locally in your browser.</li>
                    </ul>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-bold text-white uppercase tracking-widest mb-6 border-b border-white/10 pb-2">Metric Definitions</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-blue-400 mb-1">ACC - Accuracy</div>
                        <p class="text-[11px] text-gray-400">Your overall move quality compared to the engine's top choice. Weighted by game phase.</p>
                    </div>
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-purple-400 mb-1">CAL - Calculation</div>
                        <p class="text-[11px] text-gray-400">Your ability to find the only winning path in sharp, tactical positions.</p>
                    </div>
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-green-400 mb-1">INT - Intuition</div>
                        <p class="text-[11px] text-gray-400">How accurately you play when moving fast.</p>
                    </div>
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-yellow-400 mb-1">TMG - Time Mgmt</div>
                        <p class="text-[11px] text-gray-400">Do you avoid time trouble? Punishes "Rushing" (blundering fast) and "Freezing" (thinking too long in simple spots).</p>
                    </div>
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-red-400 mb-1">RES - Resilience</div>
                        <p class="text-[11px] text-gray-400">Your ability to defend and not collapse when playing from a losing position.</p>
                    </div>
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-orange-400 mb-1">TAC - Tactics</div>
                        <p class="text-[11px] text-gray-400">How often you spot opponent blunders and execute forced winning sequences.</p>
                    </div>
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-cyan-400 mb-1">STR - Strategy</div>
                        <p class="text-[11px] text-gray-400">Your ability to improve your position (Space, Mobility) in quiet moments without tactics.</p>
                    </div>
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-pink-400 mb-1">ATK - Attack</div>
                        <p class="text-[11px] text-gray-400">Your ability to sustain threats and pressure against the opponent's king.</p>
                    </div>
                    <div class="metric-grid-item">
                        <div class="text-xs font-bold text-gray-300 mb-1">DEF - Defense</div>
                        <p class="text-[11px] text-gray-400">Your ability to neutralize incoming threats and hold the line under fire.</p>
                    </div>
                     <div class="metric-grid-item">
                        <div class="text-xs font-bold text-gray-500 mb-1">OPN/MID/END</div>
                        <p class="text-[11px] text-gray-400">Specific accuracy scores for the Opening, Middlegame, and Endgame phases.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

    <script>
	
	// Close modal when clicking outside
	document.getElementById('info-modal').addEventListener('click', function(e) {
		if (e.target === this) {
			this.classList.add('hidden');
		}
	});
    // --- CONFIGURATION ---
    const SEARCH_DEPTH = 12;
    const THREAD_COUNT = navigator.hardwareConcurrency || 4;
    
    // --- STATE MANAGEMENT ---
    let workerPool = [];

    // --- WORKER FACTORY ---
    function createStockfishWorker() {
        const baseUrl = new URL('/static/package/', window.location.href).href;
        const scriptUrl = baseUrl + 'stockfish.js'; 

        const workerSource = `
            var Module = {
                locateFile: function(path) {
                    if (path.indexOf('http') === 0) return path;
                    return '${baseUrl}' + path;
                },
                mainScriptUrlOrBlob: '${scriptUrl}'
            };
            
            var pendingMessages = [];
            var engineInstance = null;

            self.onmessage = function(event) {
                if (engineInstance) {
                    engineInstance.postMessage(event.data);
                } else {
                    pendingMessages.push(event.data);
                }
            };

            importScripts('${scriptUrl}');

            Stockfish(Module).then(sf => {
                engineInstance = sf;
                sf.addMessageListener(function(line) {
                    self.postMessage(line);
                });
                while (pendingMessages.length > 0) {
                    sf.postMessage(pendingMessages.shift());
                }
            }).catch(err => {
                console.error("Worker Error:", err);
            });
        `;

        const blob = new Blob([workerSource], { type: 'application/javascript' });
        return new Worker(URL.createObjectURL(blob));
    }

    // --- UI HELPERS ---
    const proxy = (url) => `/proxy_image?url=${encodeURIComponent(url)}`;

    function showToast(msg) {
        const t = document.getElementById('toast');
        const msgEl = document.getElementById('toast-msg');
        if (t && msgEl) {
            msgEl.textContent = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 4000);
        }
    }

    function updateProgressBar(processed, total) {
        const container = document.getElementById('progress-container');
        const bar = document.getElementById('progress-bar');
        const text = document.getElementById('progress-text');
        
        if (container && bar && text) {
            container.classList.remove('hidden');
            const pct = (processed / total) * 100;
            bar.style.width = `${pct}%`;
            text.textContent = `Analyzed ${processed} / ${total} games...`;
        }
    }

    // --- CORE PROCESS ---

    async function startProcess() {
        const usernameInput = document.getElementById('usernameInput');
        const currentUsername = usernameInput.value.trim();
        const btn = document.getElementById('searchBtn');

        if (!currentUsername) {
            showToast("Please enter a username");
            return;
        }

        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<div class="loader w-4 h-4"></div>';
        }

        try {
            // 1. Initialize Session
            const initResp = await fetch('/api/init_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUsername })
            });

            if (!initResp.ok) throw new Error("Player not found or Service Unavailable");
            const profileData = await initResp.json();
            updateCardUI(profileData);

            // 2. Fetch Games
            const games = await fetchLast100Games(currentUsername);
            if (games.length === 0) throw new Error("No games found for this user.");

            // 3. Initialize Workers
            if (workerPool.length === 0) {
                console.log(`Initializing pool with ${THREAD_COUNT} workers...`);
                for (let i = 0; i < THREAD_COUNT; i++) {
                    const w = createStockfishWorker(); 
                    w.postMessage('uci');
                    w.postMessage('setoption name Threads value 1'); 
                    w.postMessage('setoption name Hash value 16');
                    w.postMessage('setoption name MultiPV value 3'); 
                    workerPool.push(w);
                }
            }

            // 4. Start Parallel Analysis (Wait for ALL to complete)
            await processGamesInParallel(games, currentUsername);

            // 5. Finalize Session (The Fix)
            const finalResp = await fetch('/api/finalize_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUsername })
            });

            if (finalResp.ok) {
                const finalData = await finalResp.json();
                updateCardMetrics(finalData); // Updates description to final title
            }

            // Cleanup UI
            const progressText = document.getElementById('progress-text');
            if (progressText) progressText.textContent = "Analysis Complete!";
            const dlBtn = document.getElementById('downloadBtn');
            if (dlBtn) dlBtn.disabled = false;

        } catch (error) {
            console.error(error);
            showToast(error.message || "An unexpected error occurred");
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i>';
            }
        }
    }

    async function fetchLast100Games(username) {
        try {
            const archivesResp = await fetch(`https://api.chess.com/pub/player/${username}/games/archives`);
            if (!archivesResp.ok) throw new Error("Failed to fetch archives");
            const archivesData = await archivesResp.json();
            const archives = archivesData.archives.reverse(); 

            let allGames = [];
            for (const url of archives) {
                if (allGames.length >= 100) break;
                
                const resp = await fetch(url);
                if (resp.ok) {
                    const data = await resp.json();
                    
                    // Filter games BEFORE adding them to the list
                    const validGames = data.games.reverse().filter(game => {
                        // 1. Rule Check: Must be standard chess (excludes 'chess960', 'bughouse', etc.)
                        const isStandard = game.rules === 'chess';
                        
                        // 2. Length Check: Must check PGN for move count
                        // We check if "6." exists (White's 6th move). 
                        // This excludes games that ended in 3, 4, or 5 moves.
                        const pgn = game.pgn || "";
                        const isLongEnough = pgn.includes("6."); 
                        
                        return isStandard && isLongEnough;
                    });

                    allGames = allGames.concat(validGames);
                }
            }
            // Return exactly 100 valid games
            return allGames.slice(0, 100);
        } catch (e) {
            console.error("Game fetch error:", e);
            throw e;
        }
    }

    async function processGamesInParallel(games, username) {
        let gamesQueue = [...games]; 
        let gamesCompleted = 0;
        let totalGames = games.length;

        const workerTask = async (worker) => {
            while (gamesQueue.length > 0) {
                const game = gamesQueue.shift(); 
                if (!game) break; 

                try {
                    const analysisData = await analyzeGameDualMode(game.pgn, worker);
                    
                    // Note: No 'is_final' flag here anymore
                    const payload = {
                        username: username,
                        pgn: game.pgn,
                        analysis: analysisData
                    };

                    const resp = await fetch('/api/process_game_result', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (resp.ok) {
                        const updatedCardData = await resp.json();
                        updateCardMetrics(updatedCardData);
                    }
                } catch (err) {
                    console.warn("Skipping game error:", err);
                } finally {
                    gamesCompleted++;
                    updateProgressBar(gamesCompleted, totalGames);
                }
            }
        };

        await Promise.all(workerPool.map(w => workerTask(w)));
    }

    function analyzeGameDualMode(pgn, worker) {
        return new Promise((resolve) => {
            const chess = new Chess();
            try {
                if (!chess.load_pgn(pgn)) { resolve([]); return; }
            } catch (e) { resolve([]); return; }

            const history = chess.history({ verbose: true });
            let analysisData = []; 
            let currentMoveIndex = 0;
            let searchPhase = 'classical'; 
            let currentClassicalTrace = null;
            let currentTopLines = [];

            // Reset
            worker.currentLines = {};
            worker.traceBuffer = ""; 

            const processNextStep = () => {
                if (currentMoveIndex >= history.length) {
                    worker.onmessage = null; 
                    resolve(analysisData);
                    return;
                }
                
                worker.currentLines = {}; 
                worker.traceBuffer = ""; 
                const isWhiteTurn = (currentMoveIndex % 2 === 0);
                worker.currentPerspective = isWhiteTurn ? 1 : -1;

                let movesString = "position startpos moves";
                for(let j=0; j < currentMoveIndex; j++) { 
                    const m = history[j];
                    movesString += " " + m.from + m.to + (m.promotion || '');
                }

                const playedMoveObj = history[currentMoveIndex];
                const playedMoveLAN = playedMoveObj.from + playedMoveObj.to + (playedMoveObj.promotion || '');
                worker.currentPlayedMoveLAN = playedMoveLAN;

                if (searchPhase === 'classical') {
                    worker.postMessage('setoption name Use NNUE value false');
                    worker.postMessage(movesString);
                    worker.postMessage('eval'); 
                    worker.postMessage('go nodes 1'); 
                } else if (searchPhase === 'nnue_best') {
                    worker.postMessage('setoption name Use NNUE value true');
                    worker.postMessage('setoption name MultiPV value 3'); 
                    worker.postMessage(movesString);
                    worker.postMessage(`go depth ${SEARCH_DEPTH}`); 
                } else if (searchPhase === 'nnue_played') {
                    worker.postMessage('setoption name MultiPV value 1'); 
                    worker.postMessage(movesString);
                    worker.postMessage(`go depth ${SEARCH_DEPTH} searchmoves ${playedMoveLAN}`); 
                }
            };

            worker.onmessage = (e) => {
                const msg = e.data;
                if (typeof msg !== 'string') return;

                if (searchPhase === 'classical') {
                    if (!msg.startsWith('info') && !msg.startsWith('bestmove') && !msg.startsWith('option')) {
                        worker.traceBuffer += msg + "\n";
                    }
                }

                if (msg.startsWith('info') && msg.includes('score') && msg.includes('pv')) {
                    let multipv = 1;
                    const pvMatch = msg.match(/multipv (\d+)/);
                    if (pvMatch) multipv = parseInt(pvMatch[1]);

                    let score = 0;
                    if(msg.includes('cp')) {
                        const match = msg.match(/cp (-?\d+)/);
                        if(match) score = parseInt(match[1]);
                    } else if (msg.includes('mate')) {
                        const match = msg.match(/mate (-?\d+)/);
                        if(match) score = parseInt(match[1]) > 0 ? 2000 : -2000;
                    }
                    score = score * worker.currentPerspective;

                    const pvIndex = msg.indexOf(' pv ');
                    let bestMoveLan = "";
                    if (pvIndex !== -1) {
                        bestMoveLan = msg.substring(pvIndex + 4).split(' ')[0];
                    }

                    if (!worker.currentLines) worker.currentLines = {};
                    worker.currentLines[multipv] = { rank: multipv, score: score, move: bestMoveLan };
                }
                
                if (msg.startsWith('bestmove')) {
                    if (searchPhase === 'classical') {
                        currentClassicalTrace = worker.traceBuffer;
                        searchPhase = 'nnue_best';
                        processNextStep();
                    } else if (searchPhase === 'nnue_best') {
                        currentTopLines = Object.values(worker.currentLines || [])
                            .sort((a,b) => a.rank - b.rank).slice(0, 3);
                        searchPhase = 'nnue_played';
                        processNextStep();
                    } else if (searchPhase === 'nnue_played') {
                        const lines = Object.values(worker.currentLines || {});
                        const playedScore = (lines.length > 0) ? lines[0].score : null;
                        analysisData.push({
                            move_number: currentMoveIndex + 1,
                            played_move: worker.currentPlayedMoveLAN,
                            played_eval: playedScore,
                            top_lines: currentTopLines,
                            static_trace: currentClassicalTrace
                        });
                        searchPhase = 'classical';
                        currentClassicalTrace = null;
                        currentTopLines = [];
                        currentMoveIndex++;
                        processNextStep();
                    }
                }
            };
            processNextStep();
        });
    }

    function updateCardUI(data) {
        if (!data || !data.username) return;
        const card = document.getElementById('player-card');
        if(card) card.className = `royal-shape select-none theme-${data.theme}`;
        
        ['overall-score', 'player-username'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = data[id === 'player-username' ? 'username' : 'overall'];
        });

        const img = document.getElementById('player-img');
        if (img && !img.getAttribute('data-custom')) img.src = proxy(data.avatar);

        const flag = document.getElementById('country-flag');
        if (flag) {
            flag.src = proxy(data.country_code !== 'xx' 
                ? `https://flagcdn.com/w40/${data.country_code.toLowerCase()}.png`
                : 'https://flagcdn.com/w40/un.png');
        }

        const badge = document.getElementById('title-badge');
        if (badge) {
            badge.textContent = data.title || '';
            badge.classList.toggle('hidden', !data.title);
            badge.classList.toggle('inline-block', !!data.title);
        }

        ['rapid', 'blitz', 'bullet'].forEach(type => {
            const el = document.getElementById(`rating-${type}`);
            if(el) el.textContent = data.ratings[type] || '---';
        });
    }

    function updateCardMetrics(data) {
        if (!data) return;
        const overallEl = document.getElementById('overall-score');
        if(overallEl) overallEl.textContent = data.overall;
        
        const descEl = document.getElementById('player-description');
        if(descEl && data.description) descEl.textContent = data.description;

        const container = document.getElementById('metrics-container');
        if (!container) return;

        container.innerHTML = ''; 
        Object.entries(data.metrics).forEach(([key, value]) => {
            const row = document.createElement('div');
            row.className = 'metric-row';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'metric-name';
            nameSpan.textContent = key;
            
            const barBg = document.createElement('div');
            barBg.className = 'metric-bar-bg';
            
            const barFill = document.createElement('div');
            barFill.className = 'metric-bar-fill';
            barFill.style.width = `${value}%`;
            
            const valSpan = document.createElement('span');
            valSpan.className = 'metric-value';
            valSpan.textContent = value;
            
            barBg.appendChild(barFill);
            row.appendChild(nameSpan);
            row.appendChild(barBg);
            row.appendChild(valSpan);
            container.appendChild(row);
        });
    }

    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('player-img');
                if (img) {
                    img.src = e.target.result;
                    img.setAttribute('data-custom', 'true');
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function downloadCard() {
        const card = document.getElementById('player-card');
        const usernameEl = document.getElementById('player-username');
        if (!card || !usernameEl) return;

        const originalTransform = card.style.transform;
        card.style.transform = 'none';
        card.style.boxShadow = 'none';

        html2canvas(card, {
            scale: 2, backgroundColor: null, useCORS: true, allowTaint: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `chess-card-${usernameEl.textContent}.png`;
            link.href = canvas.toDataURL();
            link.click();
            card.style.transform = originalTransform;
            card.style.boxShadow = '';
        });
    }
</script>
</body>
</html>
