<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Player Card Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- HTML2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        display: ['Cinzel', 'serif'],
                    },
                    colors: {
                        'chess-dark': '#0f0f13',
                        'chess-panel': '#1a1a20',
                        'chess-accent': '#3b82f6', 
                        'chess-gold': '#fbbf24',
                        'card-bg': '#121212',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Effects */
        .glass-panel {
            background: rgba(26, 26, 32, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Card Themes */
        .theme-common {
            --primary-glow: rgba(59, 130, 246, 0.6);
            --border-gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 50%, #2563eb 100%);
            --text-accent: #60a5fa;
            --bg-gradient: linear-gradient(160deg, #1e293b 0%, #0f172a 100%);
            --hex-border: #3b82f6;
        }

        .theme-titled {
            --primary-glow: rgba(251, 191, 36, 0.6);
            --border-gradient: linear-gradient(135deg, #b45309 0%, #fbbf24 50%, #fcd34d 100%);
            --text-accent: #fcd34d;
            --bg-gradient: linear-gradient(160deg, #451a03 0%, #1a0f0a 100%);
            --hex-border: #fbbf24;
        }

        .theme-gm {
            --primary-glow: rgba(167, 139, 250, 0.6);
            --border-gradient: linear-gradient(135deg, #7c3aed 0%, #a78bfa 50%, #8b5cf6 100%);
            --text-accent: #a78bfa;
            --bg-gradient: linear-gradient(160deg, #2e1065 0%, #020617 100%);
            --hex-border: #c4b5fd;
        }

        /* ROYAL SHAPE DEFINITION */
        /* This polygon cuts the corners (chamfered) */
        .royal-shape {
            clip-path: polygon(
                25px 0, 
                calc(100% - 25px) 0, 
                100% 25px, 
                100% calc(100% - 25px), 
                calc(100% - 25px) 100%, 
                25px 100%, 
                0 calc(100% - 25px), 
                0 25px
            );
        }

        /* The Card Container (Acts as the Border) */
        #player-card {
            width: 400px; 
            height: 680px;
            position: relative;
            background: var(--border-gradient); /* The border color comes from here */
            padding: 4px; /* Thickness of the border */
            box-shadow: 0 0 50px var(--primary-glow);
            transition: all 0.5s ease;
        }

        /* The Inner Card Content (The dark background) */
        .card-inner-content {
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            position: relative;
            overflow: hidden;
        }

        /* Background Pattern */
        .bg-pattern {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.5;
            z-index: 0;
        }

        /* Hexagon Mask for Image */
        .hex-wrapper {
            width: 140px;
            height: 140px;
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            background: var(--hex-border);
            padding: 3px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
            box-shadow: 0 0 30px var(--primary-glow);
        }
        .hex-inner {
            width: 100%;
            height: 100%;
            background: #000;
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .hex-inner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Metric Bars */
        .metric-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .metric-name {
            font-size: 0.75rem; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255,255,255,0.9);
            width: 40px;
            text-align: left;
            padding-right: 4px;
        }
        .metric-bar-bg {
            flex-grow: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        .metric-bar-fill {
            height: 100%;
            background: var(--text-accent);
            width: 0%;
            transition: width 1s ease-out;
            box-shadow: 0 0 5px var(--text-accent);
        }
        .metric-value {
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            width: 25px;
            text-align: right;
            padding-left: 5px;
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Decorative "Royal" elements */
        .royal-decor-top {
            position: absolute;
            top: 10px; left: 50%; transform: translateX(-50%);
            width: 80%; height: 1px;
            background: linear-gradient(90deg, transparent, var(--text-accent), transparent);
            z-index: 5;
        }
        .royal-decor-bottom {
            position: absolute;
            bottom: 10px; left: 50%; transform: translateX(-50%);
            width: 80%; height: 1px;
            background: linear-gradient(90deg, transparent, var(--text-accent), transparent);
            z-index: 5;
        }
    </style>
</head>
<body class="bg-chess-dark text-gray-200 min-h-screen font-sans selection:bg-blue-500 selection:text-white flex items-center justify-center p-4">

    <div class="container max-w-6xl mx-auto flex flex-col lg:flex-row gap-8 items-start justify-center">

        <!-- Controls Panel -->
        <div class="w-full lg:w-1/3 glass-panel p-6 rounded-2xl shadow-2xl flex flex-col gap-6 relative z-20">
            <div class="flex items-center gap-3 border-b border-gray-700 pb-4">
                <i class="fas fa-chess-knight text-3xl text-blue-500"></i>
                <div>
                    <h1 class="text-xl font-display font-bold text-white">Card Generator</h1>
                    <p class="text-xs text-gray-400">Powered by Chess.com & Python</p>
                </div>
            </div>

            <!-- Input Section -->
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Chess.com Username</label>
                    <div class="flex gap-2">
                        <input type="text" id="usernameInput" placeholder="e.g. Hikaru" 
                            class="w-full bg-black/40 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors text-white text-sm placeholder-gray-600">
                        <button onclick="fetchData()" id="searchBtn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-5 rounded-lg font-bold transition-all shadow-lg hover:shadow-blue-500/30 flex items-center justify-center">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <p id="errorMsg" class="text-red-400 text-xs mt-2 hidden flex items-center gap-2">
                        <i class="fas fa-exclamation-circle"></i> <span>Player not found.</span>
                    </p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Custom Image</label>
                    <label class="flex items-center gap-3 w-full bg-black/40 border border-gray-700 border-dashed rounded-lg px-4 py-3 cursor-pointer hover:border-blue-500/50 hover:bg-black/60 transition-all group">
                        <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center group-hover:bg-blue-600 transition-colors">
                            <i class="fas fa-camera text-gray-400 group-hover:text-white text-xs"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-300 font-medium">Upload File</span>
                            <span class="text-[10px] text-gray-500">Supports JPG, PNG</span>
                        </div>
                        <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    </label>
                </div>

                <div class="pt-4 border-t border-gray-700">
                    <button onclick="downloadCard()" id="downloadBtn" disabled
                        class="w-full bg-gray-800 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed text-white py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2 group">
                        <i class="fas fa-download group-hover:animate-bounce"></i> Download Card
                    </button>
                </div>
            </div>

            <!-- Info Box -->
            <div class="bg-blue-900/10 border border-blue-500/20 p-4 rounded-lg">
                <div class="flex gap-3">
                    <i class="fas fa-info-circle text-blue-400 mt-1"></i>
                    <div class="text-xs text-blue-200/80 leading-relaxed">
                        <p class="mb-2"><strong>Themes:</strong> Automatically detects titles (GM, IM, FM) to apply Gold/Purple themes.</p>
                        <p><strong>Metrics:</strong> Ratings are real. Skills (Tactics, etc.) are generated by the backend AI logic.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Preview Section -->
        <div class="w-full lg:w-auto flex justify-center perspective-1000">
            
            <!-- The Card (Acts as the Border Container) -->
            <div id="player-card" class="theme-common royal-shape select-none">
                
                <!-- Inner Content (The Dark Background) -->
                <div class="card-inner-content royal-shape">
                    
                    <div class="bg-pattern"></div>
                    <div class="royal-decor-top"></div>
                    <div class="royal-decor-bottom"></div>
                    
                    <!-- Decorative Inner Corners (Subtle lines) -->
                    <div class="absolute top-2 left-2 w-8 h-8 border-t border-l border-[var(--text-accent)] opacity-30"></div>
                    <div class="absolute top-2 right-2 w-8 h-8 border-t border-r border-[var(--text-accent)] opacity-30"></div>
                    <div class="absolute bottom-2 left-2 w-8 h-8 border-b border-l border-[var(--text-accent)] opacity-30"></div>
                    <div class="absolute bottom-2 right-2 w-8 h-8 border-b border-r border-[var(--text-accent)] opacity-30"></div>

                    <!-- Header Area -->
                    <div class="relative z-10 pt-12 px-6 text-center">
                        
                        <!-- Overall Score (FIFA style) -->
                        <div class="absolute top-10 left-8 flex flex-col items-center">
                            <span class="text-[9px] tracking-[0.2em] font-bold text-gray-400 uppercase">OVR</span>
                            <span id="overall-score" class="text-4xl font-display font-black text-[var(--text-accent)] leading-none drop-shadow-lg">--</span>
                        </div>

                        <!-- Country Flag -->
                        <div class="absolute top-10 right-8 flex flex-col items-center">
                            <img id="country-flag" src="https://flagcdn.com/w40/un.png" class="w-8 rounded shadow-md opacity-80" alt="Flag">
                        </div>

                        <!-- Avatar Hexagon -->
                        <div class="hex-wrapper mb-4 transition-transform duration-500 hover:scale-105">
                            <div class="hex-inner">
                                <img id="player-img" src="https://www.chess.com/bundles/web/images/user-image.svg" alt="Player">
                            </div>
                        </div>

                        <!-- Title Badge -->
                        <div id="title-badge" class="hidden inline-block bg-[var(--hex-border)] text-black font-black text-xs px-2 py-0.5 rounded shadow-lg mb-2 uppercase tracking-wide transform -skew-x-12">
                            GM
                        </div>

                        <!-- Username (Main Title) -->
                        <h2 id="player-username" class="text-3xl font-display font-black text-white tracking-widest truncate px-2 drop-shadow-md uppercase mt-1">USERNAME</h2>
                        
                        <!-- Description (Updated: Bigger & Fancy) -->
                        <p id="player-description" class="text-sm font-display font-bold text-[var(--text-accent)] uppercase tracking-widest mt-2 px-4 py-1 border-t border-b border-[var(--text-accent)] inline-block opacity-90 bg-black/30">Player Style</p>
                    </div>

                    <!-- Ratings Section -->
                    <div class="relative z-10 grid grid-cols-3 gap-2 px-6 py-6 mt-1">
                        <div class="text-center p-2 bg-white/5 backdrop-blur-sm border-t border-b border-white/10">
                            <div class="text-[9px] text-gray-400 uppercase tracking-wider mb-1">Rapid</div>
                            <div id="rating-rapid" class="text-lg font-bold text-[var(--text-accent)]">---</div>
                        </div>
                        <div class="text-center p-2 bg-white/5 backdrop-blur-sm border-t border-b border-white/10">
                            <div class="text-[9px] text-gray-400 uppercase tracking-wider mb-1">Blitz</div>
                            <div id="rating-blitz" class="text-lg font-bold text-[var(--text-accent)]">---</div>
                        </div>
                        <div class="text-center p-2 bg-white/5 backdrop-blur-sm border-t border-b border-white/10">
                            <div class="text-[9px] text-gray-400 uppercase tracking-wider mb-1">Bullet</div>
                            <div id="rating-bullet" class="text-lg font-bold text-[var(--text-accent)]">---</div>
                        </div>
                    </div>

                    <!-- Metrics Grid -->
                    <div class="relative z-10 px-6 pb-6">
                        <div id="metrics-container" class="grid grid-cols-2 gap-x-6 gap-y-1 mt-6">
                            <!-- Metrics will be injected here by JS -->
                            <!-- Placeholder Layout -->
                            <div class="metric-row"><span class="metric-name">OPN</span><div class="metric-bar-bg"><div class="metric-bar-fill" style="width: 0%"></div></div><span class="metric-value">--</span></div>
                            <div class="metric-row"><span class="metric-name">MID</span><div class="metric-bar-bg"><div class="metric-bar-fill" style="width: 0%"></div></div><span class="metric-value">--</span></div>
                            <div class="metric-row"><span class="metric-name">END</span><div class="metric-bar-bg"><div class="metric-bar-fill" style="width: 0%"></div></div><span class="metric-value">--</span></div>
                            <div class="metric-row"><span class="metric-name">TAC</span><div class="metric-bar-bg"><div class="metric-bar-fill" style="width: 0%"></div></div><span class="metric-value">--</span></div>
                        </div>
                    </div>

                    <!-- Footer / Logo Area -->
                    <div class="absolute bottom-2 w-full text-center z-10">
                        <img src="/static/images/circle_logo.png" class="h-16 mx-auto opacity-90" alt="Logo">
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        const API_URL = '/api/generate';

        async function fetchData() {
            const username = document.getElementById('usernameInput').value.trim();
            const btn = document.getElementById('searchBtn');
            const errorMsg = document.getElementById('errorMsg');
            const downloadBtn = document.getElementById('downloadBtn');

            if (!username) return;

            // Loading State
            btn.innerHTML = '<div class="loader w-4 h-4 border-2"></div>';
            btn.disabled = true;
            errorMsg.classList.add('hidden');
            downloadBtn.disabled = true;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                if (!response.ok) throw new Error('Player not found');

                const data = await response.json();
                updateCard(data);
                downloadBtn.disabled = false;

            } catch (error) {
                console.error(error);
                errorMsg.classList.remove('hidden');
            } finally {
                btn.innerHTML = '<i class="fas fa-search"></i>';
                btn.disabled = false;
            }
        }

        function updateCard(data) {
            const card = document.getElementById('player-card');
            
            // 1. Theme Application
            card.className = `royal-shape select-none theme-${data.theme}`;

            // 2. Basic Info
            document.getElementById('overall-score').innerText = data.overall;
            document.getElementById('player-username').innerText = data.username;
            document.getElementById('player-description').innerText = data.description;
            
            // Image
            const img = document.getElementById('player-img');
            if (!img.getAttribute('data-custom')) {
                img.src = data.avatar;
            }

            // Flag
            const flagUrl = data.country_code !== 'xx' 
                ? `https://flagcdn.com/w40/${data.country_code.toLowerCase()}.png`
                : 'https://flagcdn.com/w40/un.png';
            document.getElementById('country-flag').src = flagUrl;

            // Title Badge
            const badge = document.getElementById('title-badge');
            if (data.title) {
                badge.innerText = data.title;
                badge.classList.remove('hidden');
                badge.classList.add('inline-block');
            } else {
                badge.classList.add('hidden');
                badge.classList.remove('inline-block');
            }

            // 3. Ratings
            document.getElementById('rating-rapid').innerText = data.ratings.rapid;
            document.getElementById('rating-blitz').innerText = data.ratings.blitz;
            document.getElementById('rating-bullet').innerText = data.ratings.bullet;

            // 4. Metrics Generation
            const container = document.getElementById('metrics-container');
            container.innerHTML = '';
            
            Object.entries(data.metrics).forEach(([key, value]) => {
                const row = document.createElement('div');
                row.className = 'metric-row';
                row.innerHTML = `
                    <span class="metric-name">${key}</span>
                    <div class="metric-bar-bg">
                        <div class="metric-bar-fill" style="width: 0%"></div>
                    </div>
                    <span class="metric-value">${value}</span>
                `;
                container.appendChild(row);
                
                // Animate bar after a slight delay
                setTimeout(() => {
                    row.querySelector('.metric-bar-fill').style.width = `${value}%`;
                }, 100);
            });
        }

        // Handle Custom Image Upload locally
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('player-img');
                    img.src = e.target.result;
                    img.setAttribute('data-custom', 'true'); // Flag to prevent overwrite on next search
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Download Functionality
        function downloadCard() {
            const card = document.getElementById('player-card');
            
            // Note: html2canvas has issues with advanced clip-paths sometimes.
            // We keep the transform reset.
            const originalTransform = card.style.transform;
            card.style.transform = 'none';
            card.style.boxShadow = 'none';

            html2canvas(card, {
                scale: 2, // High resolution
                backgroundColor: null,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `chess-card-${document.getElementById('player-username').innerText}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                // Restore styles
                card.style.transform = originalTransform;
                card.style.boxShadow = '';
            });
        }
    </script>
</body>
</html>